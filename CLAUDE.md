# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Sigar (System Information Gatherer And Reporter) is a cross-platform C library for gathering OS and process information, with Ruby bindings distributed as the `kostya-sigar` gem. This is a fork of hyperic/sigar, which is **abandonware** — the original project is unmaintained, and this fork (kostya/sigar) had only received sporadic compilation fixes since 2018. It exists as a dependency of the [Eye gem](https://github.com/kostya/eye).

**We are rehabilitating and modernizing this codebase.** Significant cleanup has been done (dead platforms removed, Perl dependency eliminated, tests expanded, C code hardened), but legacy patterns remain in the C code: `WIN32`/`_AIX`/`__hpux`/`__sun` ifdefs in shared files (compile-time dead code on supported platforms), deprecated Ruby `Data_Wrap_Struct` API usage (368 warnings), and `sigar_getline.c` which is an unused terminal line editor.

## Build Commands

```bash
# Install dependencies
bundle install

# Build the Ruby C extension (runs extconf.rb + make)
bundle exec rake build

# Run tests (builds first automatically)
bundle exec rake test

# Run all Ruby examples
bundle exec rake examples

# Clean compiled artifacts
bundle exec rake clean

# Full clean including generated files and symlinks
bundle exec rake distclean

# Build the gem package
bundle exec rake package
```

**Required:** Ruby >= 3.3, C compiler (clang or gcc). No Perl dependency.

## Architecture

### Core C Library (`src/`)

- `sigar.c` — Main library: process info, memory, CPU, swap, uptime, load average, resource limits
- `sigar_cache.c` — LRU cache for expensive system calls
- `sigar_ptql.c` — Process Table Query Language: a custom query language for filtering processes by pid, state, name, args, etc.
- `sigar_fileinfo.c` — File stat/permissions abstraction
- `sigar_format.c` — Output formatting (sizes, addresses, etc.)
- `sigar_util.c` — /proc parsing, string utilities, file reading helpers
- `sigar_getline.c` — Terminal line editor (legacy, not used by Ruby binding)

### Platform Abstraction (`src/os/<platform>/`)

Each OS has its own `<os>_sigar.c` and `sigar_os.h` implementing the platform-specific syscalls. The build selects the correct OS directory based on `RUBY_PLATFORM` in `extconf.rb`:

| Platform pattern | OS dir | Notes |
|---|---|---|
| `/darwin/` | `darwin/` | Uses CoreServices + IOKit frameworks |
| `/bsd/` | `darwin/` | Shared with Darwin, uses libkvm |
| `/linux/` | `linux/` | Parses /proc filesystem |

Unsupported platforms (AIX, HP-UX, Solaris, Win32) have been removed. The `else` branch in `extconf.rb` raises an error. Note: scattered `#ifdef WIN32`, `_AIX`, `__hpux`, `__sun` guards remain in the shared C files — these are compile-time dead code on supported platforms and can be cleaned up incrementally.

### Ruby Binding (`bindings/ruby/`)

- `extconf.rb` — mkmf-based configuration. Detects platform, sets compiler flags, symlinks all C sources into the build directory, and generates `sigar_version.c` from a template.
- `rbsigar.c` — Hand-written Ruby C extension wrapping `sigar_t`. Exposes classes like `Sigar::Cpu`, `Sigar::Mem`, `Sigar::Swap`, `Sigar::ProcMem`, `Sigar::FileSystemUsage`, etc.
- `rbsigar_generated.rx` — Checked-in generated C code (~2900 lines) containing struct-to-Ruby-class mappings. Originally generated by a Perl script that has been removed.

### Tests (`bindings/ruby/test/`)

Tests use Minitest and run via `bundle exec rake test`. The Rakefile `chdir`s into `bindings/ruby/` before running tests, so test paths are relative to that directory.

Coverage: CPU, memory, swap, uptime, load average, filesystem, process info (state/mem/time/args/env/exe/cred), network (interfaces/config/stats/routes/tcp), system info, resource limits, and a smoke test exercising all no-arg methods.

## Key Build Caveats

- `extconf.rb` symlinks all `src/*.c` and `src/os/<platform>/*.c` files into `bindings/ruby/` at configure time. `rake distclean` removes these symlinks. Be careful not to `rm -f *.c` in `bindings/ruby/` — that would delete the real `rbsigar.c`.
- On Linux with glibc >= 2.26, `sys/sysmacros.h` must be included separately (handled via `LINUX_SYSMACROS` define).
- Version is defined in `version.properties` and read by both the `Rakefile` and `extconf.rb`.
- `sigar_version.c` is generated at build time by Ruby code in `extconf.rb` (template: `src/sigar_version.c.in`).

## Known Modernization Targets

- **`Data_Wrap_Struct` → `TypedData` migration**: The Ruby C API's `Data_Wrap_Struct`/`Data_Get_Struct` are deprecated. Both `rbsigar.c` and `rbsigar_generated.rx` use them extensively (368 warnings). Migrating to `TypedData_Wrap_Struct`/`TypedData_Get_Struct` requires defining `rb_data_type_t` structs for each wrapped type.
- **Dead platform ifdefs in shared C**: `#ifdef WIN32`, `_AIX`, `__hpux`, `__sun` blocks in `sigar.c`, `sigar_util.c`, `sigar_format.c`, `sigar_ptql.c`, `sigar_fileinfo.c`. These are harmless (never compiled) but add noise.
- **`sigar_getline.c`**: An entire terminal line editor (~1600 lines) that the Ruby binding doesn't use. Contains its own `strcpy` calls. Candidate for removal.
